<section class="pub-list-page">
  <!-- ✅ Sticky condensed controls -->
  <section class="controls-section sticky-controls">
    <div class="controls-row">
      <!-- Condensed Search -->
      <div class="search-compact">
        <app-icon name="search" size="sm" class="search-icon" />
        <input
          type="search"
          class="search-input"
          placeholder="Search pubs..."
          [value]="searchTerm()"
          (input)="setSearchTerm($event)"
          autocomplete="off"
          aria-label="Search pubs"
        />
        @if (searchTerm()) {
          <button
            class="clear-search-btn"
            (click)="clearSearch()"
            type="button"
            aria-label="Clear search"
          >
            <app-icon name="close" size="xs" />
          </button>
        }
      </div>

      <!-- Condensed Filter Pills -->
      <div class="filter-pills-compact">
        @for (option of filterOptions; track option.value) {
          <button
            class="filter-pill-compact"
            [class.active]="filterMode() === option.value"
            (click)="setFilter(option.value)"
            type="button"
            [attr.aria-pressed]="filterMode() === option.value"
          >
            {{ option.label }} ({{ getFilterCount(option.value) }})
          </button>
        }
      </div>

      <!-- Management Toggle -->
      <button
        class="manage-toggle-compact"
        [class.active]="isManagementMode()"
        (click)="toggleManagementMode()"
        type="button"
        [attr.aria-pressed]="isManagementMode()"
      >
        @if (isManagementMode()) {
          <app-icon name="check" size="sm" />
        } @else {
          <app-icon name="edit" size="sm" />
        }
      </button>
    </div>
  </section>

  <!-- ✅ Subtle selection indicator (only when in management mode with selections) -->
  @if (isManagementMode() && selectedCount() > 0) {
    <div class="selection-indicator">
      <span class="selection-count">{{ selectedCount() }} selected</span>
      <span class="selection-help">Changes saved when you exit edit mode</span>
    </div>
  }

  <!-- ✅ Main content area with better space usage -->
  <section class="pub-list-container">
    @if (pubStore.loading()) {
      <ff-loading-state text="Loading pubs..." />
    } @else if (pubStore.error()) {
      <ff-error-state
        [message]="pubStore.error()!"
        [showRetry]="true"
        retryText="Try Again"
        (retry)="retryLoad()"
      />
    } @else if (filteredPubs().length === 0) {
      <ff-empty-state
        icon="🍺"
        title="No pubs found"
        subtitle="Try adjusting your search or filters."
        [showAction]="true"
        actionText="Clear Filters"
        (action)="resetFilters()"
      />
    } @else {
      <div class="pub-grid">
        @for (pub of filteredPubs(); track pub.id) {
          @if (isManagementMode()) {
            <!-- In management mode: no navigation, show selection -->
            <div class="pub-card-container">
              <app-pub-card
                [pub]="pub"
                [hasCheckedIn]="hasAnyVisit(pub.id)"
                [hasVerifiedVisit]="hasVerifiedCheckIn(pub.id)"
                [hasUnverifiedVisit]="hasUnverifiedVisit(pub.id)"
                [checkinCount]="dataAggregatorService.getVisitCountForPub(pub.id)"
                [showCheckinCount]="hasAnyVisit(pub.id)"
                [isLocalPub]="dataAggregatorService.isLocalPub(pub.id)"
                [selectable]="true"
                [isSelected]="selectedForAddition().has(pub.id)"
                [checkInDistanceThreshold]="checkInDistanceThreshold"
                (selectionChanged)="handleSelectionChange($event)"
                (cardClicked)="handlePubClick(pub)"
              />
            </div>
          } @else {
            <!-- Normal mode: navigation enabled -->
            <!-- <a
              [routerLink]="['/pubs', pub.id]"
              class="pub-card-link"
              [attr.aria-label]="'View details for ' + pub.name"
            > -->
            <app-pub-card
              [pub]="pub"
              [hasCheckedIn]="hasAnyVisit(pub.id)"
              [hasVerifiedVisit]="hasVerifiedCheckIn(pub.id)"
              [hasUnverifiedVisit]="hasUnverifiedVisit(pub.id)"
              [checkinCount]="dataAggregatorService.getVisitCountForPub(pub.id)"
              [showCheckinCount]="hasAnyVisit(pub.id)"
              [isLocalPub]="dataAggregatorService.isLocalPub(pub.id)"
              [checkInDistanceThreshold]="checkInDistanceThreshold"
            />
            <!-- </a> -->
          }
        }
      </div>
    }
  </section>
</section>
