<!-- src/app/pubs/feature/pub-detail/pub-detail.component.html -->
<article class="pub-detail">
  @if (loading()) {
    <div class="loading-state">
      <h1>Loading pub details...</h1>
    </div>
  } @else if (error()) {
    <div class="error-state">
      <h1>Error Loading Pub</h1>
      <p>{{ error() }}</p>
      <a routerLink="/pubs">‚Üê Back to pubs</a>
    </div>
  }

  @if (pub(); as currentPub) {
    <!-- Header Section -->
    <header class="pub-header">
      <h1>{{ currentPub.name }}</h1>
      <p class="address">{{ currentPub.address }}, {{ locationString() }}</p>

      @if (userDistance()) {
        <p class="distance">
          üìç {{ (userDistance()! / 1000).toFixed(1) }}km away
          @if (isNearby()) {
            <span class="nearby-badge">‚úÖ Nearby</span>
          } @else {
            <span class="far-badge">‚ö†Ô∏è Too far</span>
          }
        </p>
      }
    </header>

    <!-- Check-in Action Section -->
    @if (canShowCheckInButton()) {
      <section class="check-in-section">
        <app-button
          [variant]="isNearby() ? 'primary' : 'secondary'"
          [disabled]="!canCheckIn() || loading()"
          [loading]="loading()"
          [fullWidth]="true"
          (onClick)="checkInToPub()"
        >
          {{ checkInButtonText() }}
        </app-button>
      </section>
    }

    <!-- Carpet Section -->
    @if (currentPub.carpetUrl) {
      <section class="carpet">
        <h2>Carpet of the Pub</h2>
        <img [src]="currentPub.carpetUrl" alt="Pub carpet" loading="lazy" />
      </section>
    }

    <!-- Current Landlord Section -->
    <section class="landlord">
      <h2>Current Landlord</h2>
      @if (currentLandlord(); as landlord) {
        <div class="landlord-info">
          @if (isUserLandlord()) {
            <div class="user-is-landlord">
              <p><strong>üëë You're the landlord!</strong></p>
              <p>Claimed: {{ formatTime(landlord.claimedAt) }}</p>
            </div>
          } @else {
            <div class="other-is-landlord">
              <p><strong>User ID:</strong> {{ landlord.userId.slice(0, 8) }}...</p>
              <p><strong>Claimed:</strong> {{ formatTime(landlord.claimedAt) }}</p>
            </div>
          }
        </div>
      } @else {
        <div class="no-landlord">
          @if (canCheckIn()) {
            <p>üè¥ No one is the landlord! Check in to claim your throne!</p>
          } @else if (userDistance()) {
            <p>üè¥ No landlord today. Get within 50m to claim it!</p>
          } @else {
            <p>üè¥ No landlord today.</p>
          }
        </div>
      }
    </section>

    <!-- Stats Section -->
    <section class="stats">
      <h2>Statistics</h2>
      <div class="stats-grid">
        <div class="stat-item">
          <span class="stat-value">{{ currentPub.checkinCount || 0 }}</span>
          <span class="stat-label">Total Check-ins</span>
        </div>

        @if (currentPub.recordEarlyCheckinAt; as earliest) {
          <div class="stat-item">
            <span class="stat-value">{{ formatTime(earliest) }}</span>
            <span class="stat-label">Earliest Check-in</span>
          </div>
        }

        @if (currentPub.recordLatestCheckinAt; as latest) {
          <div class="stat-item">
            <span class="stat-value">{{ formatTime(latest) }}</span>
            <span class="stat-label">Latest Check-in</span>
          </div>
        }

        @if (currentPub.longestStreak; as streak) {
          <div class="stat-item">
            <span class="stat-value">{{ streak }} days</span>
            <span class="stat-label">Longest Landlord Streak</span>
          </div>
        }
      </div>
    </section>

    <!-- Recent Check-ins -->
    @if (recentCheckins().length > 0) {
      <section class="history">
        <h2>Recent Check-ins</h2>
        <ul class="checkin-list">
          @for (entry of recentCheckins(); track entry.timestamp) {
            <li class="checkin-item">
              <span class="user">{{ entry.userId.slice(0, 8) }}...</span>
              <span class="timestamp">{{ formatDate(entry.timestamp) }}</span>
            </li>
          }
        </ul>
      </section>
    }

    <!-- Landlord History -->
    @if (landlordHistory().length > 0) {
      <section class="history">
        <h2>Landlord History</h2>
        <ul class="landlord-list">
          @for (entry of landlordHistory(); track entry.claimedAt) {
            <li class="landlord-item">
              <span class="timestamp">{{ formatTime(entry.claimedAt) }}</span>
              <span class="user">{{ entry.userId.slice(0, 8) }}...</span>
            </li>
          }
        </ul>
      </section>
    }

    <!-- Actions -->
    <div class="pub-actions">
      <a routerLink="/pubs" class="back-link">‚Üê Back to pubs</a>
    </div>

  } @else {
    <!-- No pub found -->
    <div class="not-found">
      <h1>Pub Not Found</h1>
      <p>The pub you're looking for doesn't exist or couldn't be loaded.</p>
      <a routerLink="/pubs">‚Üê Back to pubs</a>
    </div>
  }
</article>
