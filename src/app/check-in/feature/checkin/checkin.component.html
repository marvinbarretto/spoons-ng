<div class="checkin-container">

  <!-- Camera View -->
  @if (currentPhase() === 'CAMERA_STARTING' || currentPhase() === 'WAITING_FOR_GATES') {
    <video #videoElement
           class="camera-view"
           playsinline
           muted
           autoplay>
    </video>
  }

  <!-- Blurred Background (after photo captured) -->
  @if (capturedPhotoUrl()) {
    <div class="blurred-background"
         [style.background-image]="'url(' + capturedPhotoUrl() + ')'">
    </div>
  }

  <!-- Status Overlay -->
  <div class="status-overlay">
    <div class="status-content">

      <!-- Phase-specific content -->
      @switch (currentPhase()) {

        @case ('CAMERA_STARTING') {
          <div class="status-message">Starting camera...</div>
        }

        @case ('WAITING_FOR_GATES') {
          <div class="status-message">Point at the carpet</div>
          <div class="gates-status">

            <!-- Core Device Requirements -->
            <div class="gate-group">
              <h4>Device Position</h4>
              <div class="gate" [class.passed]="gatesPassed().deviceOriented">
                ðŸ“± Point Down: {{ gatesPassed().deviceOriented ? 'YES' : 'NO' }}
                <br><small>Beta: {{ deviceOrientation().beta }}Â°</small>
              </div>
              <div class="gate" [class.passed]="gatesPassed().motionStable">
                ðŸŽ¥ Hold Steady: {{ gatesPassed().motionStable }}
                @if (metrics()) {
                  <br><small>Motion: {{ metrics()!.motionLevel }}/100, Stable: {{ metrics()!.isStable }}</small>
                }
              </div>
            </div>

            @if (metrics()) {
              <!-- Image Quality Requirements -->
              <div class="gate-group">
                <h4>Image Quality</h4>
                <div class="gate" [class.passed]="gatesPassed().goodSharpness">
                  ðŸ” Sharpness: {{ metrics()!.sharpness }}/10{{ gatesPassed().goodSharpness ? ' âœ“' : ' (need > 10)' }}
                </div>
                <div class="gate" [class.passed]="gatesPassed().goodContrast">
                  âš¡ Contrast: {{ metrics()!.contrast }}/20{{ gatesPassed().goodContrast ? ' âœ“' : ' (need > 20)' }}
                </div>
              </div>

              <!-- Carpet Pattern Detection -->
              <div class="gate-group">
                <h4>Carpet Detection</h4>
                <div class="gate" [class.passed]="gatesPassed().hasTexture">
                  ðŸ§µ Texture: {{ metrics()!.textureComplexity }}/10{{ gatesPassed().hasTexture ? ' âœ“' : ' (need > 10)' }}
                </div>
                <div class="gate" [class.passed]="gatesPassed().hasEdges">
                  ðŸ“ Pattern: {{ metrics()!.edgeDensity }}/15{{ gatesPassed().hasEdges ? ' âœ“' : ' (need > 15)' }}
                </div>
              </div>
            }
          </div>
          @if (allGatesPassed()) {
            <button class="capture-btn" (click)="capturePhoto()">
              All conditions met - Take Photo
            </button>
          }
        }

        @case ('PHOTO_CAPTURED') {
          <div class="status-message">Photo captured! Processing...</div>
        }

        @case ('LLM_THINKING') {
          <div class="status-message">{{ currentAnalysisMessage() }}</div>
          <div class="thinking-spinner">ðŸ¤–</div>
        }

        @case ('NOT_CARPET_DETECTED') {
          <div class="status-message not-carpet">That doesn't look like a carpet</div>
          <div class="status-submessage">Try pointing at a carpet pattern</div>
          <div class="retry-countdown">Returning to camera in a moment...</div>
        }

        @case ('CHECK_IN_PROCESSING') {
          <div class="status-message">{{ pubName() }}</div>
        }

        @case ('SUCCESS_MODAL') {
          <div class="success-modal">
            <h2>Check-in Successful!</h2>
            <p>Welcome to {{ pubName() }}</p>
            <div class="success-details">
              <div>Points earned: {{ pointsEarned() }}</div>
              <div>Badges earned: {{ badgesEarned().length }}</div>
            </div>
            <button class="exit-btn" (click)="exitToHomepage()">
              Continue
            </button>
          </div>
        }
      }

    </div>
  </div>

  <!-- Debug Info -->
  <div class="debug-info">
    <div>Phase: {{ currentPhase() }}</div>
    @if (ACTIVE_DEVELOPMENT_MODE) {
      <div>ðŸš¨ DEV MODE ON</div>
    }
  </div>

  <!-- Exit Button (always available) -->
  <button class="exit-button" (click)="exitToHomepage()">
    Exit
  </button>

</div>
